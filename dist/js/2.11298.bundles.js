(window.webpackJsonp=window.webpackJsonp||[]).push([[2],{106:function(t,e,n){"use strict";var i=n(94);n.n(i).a},89:function(t,e,n){"use strict";n.r(e);var i=function(){var t=this,e=t.$createElement,n=t._self._c||e;return n("div",{staticClass:"homeWapper"},[n("div",{staticStyle:{height:"100vh"},attrs:{id:t.getId},on:{mousedown:t.initObj,mousewheel:t.initObj}}),t._v(" "),n("device-floating",{staticClass:"floatingWindow",attrs:{title:"运输工具信息"}},[n("Tree",{attrs:{data:t.getDeviceList},on:{"on-select-change":t.getDetail}})],1),t._v(" "),n("device-details",{attrs:{details:t.deviceDetail},on:{setFollowPiont:t.setFollowPiont,getTrajectory:t.getTrajectory}})],1)};i._withStripped=!0;var o=n(6),a=n.n(o),s=n(13),r=(n(11),n(37)),l=n.n(r),c=n(38),u=n.n(c),p=function(){function t(e,n){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"default";l()(this,t),this.url=e,this.msgCallback=n,this.name=i,this.ws=null,this.status=null}return u()(t,[{key:"connect",value:function(t){var e=this;this.ws=new WebSocket(this.url),this.ws.onopen=function(n){if(e.status="open",e.heartCheck(),void 0!==t)return e.ws.send(t)},this.ws.onmessage=function(t){return"pong"===t.data&&(e.pingPong="pong"),e.msgCallback(t.data)},this.ws.onclose=function(t){e.closeHandle(t)},this.onerror=function(t){e.closeHandle(t)}}},{key:"heartCheck",value:function(){var t=this;this.pingPong="ping",this.pingInterval=setInterval(function(){1===t.ws.readyState&&t.ws.send("ping")},1e4),this.pongInterval=setInterval(function(){t.pingPong=!1,"ping"===t.pingPong&&t.closeHandle("pingPong没有改变为pong"),t.pingPong="ping"},2e4)}},{key:"sendHandle",value:function(t){return this.ws.send(t)}},{key:"closeHandle",value:function(){arguments.length>0&&void 0!==arguments[0]&&arguments[0],"close"!==this.status&&(void 0!==this.pingInterval&&void 0!==this.pongInterval&&(clearInterval(this.pingInterval),clearInterval(this.pongInterval)),this.connect())}},{key:"closeMyself",value:function(){return this.status="close",this.ws.close()}}]),t}(),d={name:"home",data:function(){return{map:{},data2:[],deviceDetail:{},markerArr:[],followPiont:void 0,titlePiont:void 0}},components:{},computed:a()({},Object(s.c)("home",["getDeviceList","getPositionArr","getDetailsShow"]),{getId:function(){return"MapContain".concat(this._uid)}}),watch:{getPositionArr:function(t){this.setMapPoint(t)}},methods:a()({},Object(s.b)("home",["updateData"]),{initMap:function(){this.map=new mapboxgl.Map({container:this.getId,style:"http://service.piesat.cn:10002/styles/basic.json",center:[112,37.94],zoom:2})},setMapPoint:function(t){var e=this.map,n=this;e.flyTo({center:[t[0].point.lon,t[0].point.lat],zoom:9}),t.map(function(t){var i=[t.point.lon,t.point.lat],o=document.createElement("div");o.className="marker";var a=new mapboxgl.Marker(o).setLngLat(i).addTo(e);a.id=t.equipment,a.data=t,n.markerArr.push(a)})},getDetail:function(t,e){if(e.id){var n=this,i=this.apiPath.deviceList.getDeviceDetails;this.http.get(i,{id:e.id}).then(function(t){if(t.data){var e=t.data.data;n.deviceDetail=e,n.$store.dispatch("home/changeDetailsShow",!0)}});var o=this.markerArr.filter(function(t){return t.data.equipment==e.licencePlate})[0],a=[o.data.point.lon,o.data.point.lat],s=document.createElement("div");s.innerHTML=e.licencePlate,this.titlePiont?this.titlePiont.setLngLat(a).setHTML(s):this.titlePiont=new mapboxgl.Marker(s,{offset:[0,-20]}).setLngLat(a).addTo(this.map)}},initObj:function(){this.followPiont=void 0},getTrajectory:function(t){var e=this.apiPath.deviceList.getTrajectory,n=this;this.http.get(e,{routePlanningId:this.deviceDetail.route_planning}).then(function(e){if(e.data){var i=e.data.data,o=t.point,a=o.lon,s=o.lat;n.map.flyTo({center:[a,s],zoom:12}),n.changeTrajectory(i)}})},changeTrajectory:function(t){var e={type:"FeatureCollection",features:[{type:"Feature",geometry:{type:"LineString",coordinates:t.tracks}}]},n=t.origin.split(","),i=n[0],o=n[1];this.drawTrajectory(e,{lon:i,lat:o})},setFollowPiont:function(){var t=this;this.followPiont=this.markerArr.filter(function(e){return e.data.equipment==t.deviceDetail.licencePlate})[0],this.map.flyTo({center:[this.followPiont.data.point.lon,this.followPiont.data.point.lat],zoom:16})},drawTrajectory:function(t,e){e.lon,e.lat;var n=this.map;null==n.getLayer("line")?n.addLayer({id:"line",type:"line",source:{type:"geojson",data:t},layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"#0090FA ","line-width":3,"line-opacity":1}}):n.getSource("line").setData(t)},pointOnCircle:function(t,e){return{type:"Point",coordinates:[t,e]}},initWebSocket:function(){this.webSocket=new p(this.apiPath.webSocket.path,this.socketMessage,"wsSocket"),this.webSocket.connect('{ "Type":101,"Appid": 21,"From":1762,"To":0, "Connid":0,"ConnServerid":0, "content": "{\\"uid\\":1768,\\"user\\":\\"u\\",\\"passwd\\":\\"\\",\\"key\\":\\"\\",\\"platform\\":2,\\"lastmsgid\\":0}","time": 145546489,"Platform":1,"Payload": null}')},socketMessage:function(t){var e=JSON.parse(JSON.parse(JSON.stringify(t)));e.Content=JSON.parse(e.Content);var n=e.Content;if(n.Content){var i=this.markerArr.filter(function(t){return t.id==n.Content.equipment}),o=this.markerArr.indexOf(function(t){return t.id==n.Content.equipment});o>=0&&(this.markerArr[o].data.point={lon:n.Content.point.lon,lat:n.Content.point.lat}),this.followPiont&&this.followPiont.data.equipment==n.Content.equipment&&(this.map.flyTo({center:[n.Content.point.lon,n.Content.point.lat],zoom:16}),this.titlePiont.setLngLat([n.Content.point.lon,n.Content.point.lat])),i[0]&&i[0].setLngLat([n.Content.point.lon,n.Content.point.lat])}}}),beforeCreate:function(){},created:function(){this.$store.dispatch("home/updateData")},beforeMount:function(){},mounted:function(){this.initMap(),this.initWebSocket()},beforeDestroy:function(){},destroyed:function(){},beforeUpdate:function(){},updated:function(){}},h=(n(106),n(1)),f=Object(h.a)(d,i,[],!1,null,null,null);f.options.__file="src/views/home/home.vue",e.default=f.exports},94:function(t,e,n){}}]);